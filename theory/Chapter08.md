# 8장 합의 알고리즘

블록체인 네트워크에서 블록의 정당성에 대한 승인자간의 합의 형성을 얻어내기 위한 구조인 합의 알고리즘에 대해 설명한다.

## 용어 및 팁

## 합의 알고리즘이란?

- 합의 알고리즘이란 P2P 네트워크와 같이 정보 도달에 시간차가 있는 네트워크에서 참가자가 하나의 결과에 대한 합의를 얻기위한 알고리즘
- 블록체인은 각 노드에서 만든 블록의 정당성을 검토하고 네트워크 전체에서 공유하는 블록체인에 반영하기 위해 합의 알고리즘을 사용한다.
- P2P 네트워크에서 정보의 지연과 미도달이라는 문제가 있다. 따라서 데이터를 변조할 의도가 없다해도 이중 송신에 따른 중복처리나 잘못된 정보에 의한 오작동의 위험이 있기에 정확한 정보를 공유하기 어렵다
- 때문에 이 문제를 해결하는 것이 합의 알고리즘 이다.
- 블록체인에서는 비잔티움 문제를 어떻게 해결하느냐가 중요시된다.
- 때문에 개방,공용(Public)형 블록체인에서는 '악의가 있는 사람이 반드시 포함되어있다.' 가 기본 전제가 된다.

비트코인은 Proof of Work(계산량에 따른 증명, 이후 PoW)라는 합의 알고리즘을 사용해 처음으로 P2P 네트워크를 통해 누구나 참가 가능한 전자 화폐 시스템을 구현하였다.
하지만 이것도 정답이 아니었는지 2017년 기준으로 다양한 문제가 발생하고 있으며 PoW이외의 다양한 합의 알고리즘을 채택하고 있는 블록체인 기반 기술도 늘어가고 있다.

## PoW의 문제점

- PoW는 확률적으로 해답이 어려운 문제를 가장 빨리 해결한 사람에게 블록을 만들 수 있도록 허가하고 보상으로 코인을 준다.
- PoW는 중앙 집권적인 관리자가 없지만 사람들이 보상을 위해 네트워크에 참여하기 때문에 시스템이 자율적으로 운영된다.
- PoW는 만약 통신이 끊켜 불일치가 발생해 블록이 분기한 경우에도 가장 긴 블록체인을 올바른 것(더 많은 참가자가 승인했다고 간주)으로 함으로써 데이터의 일관성을 보장한다.
- 이 알고리즘은 운영 개시로부터 8년이 지난 지금까지도 대규모 시스템 장애를 일으킨적이 없어 안전성을 입증했다고 볼 수 있다.
- 시스템이 꺼지지 않았을 뿐이지 그래도 문제점은 있다.
- 비트코인 커뮤니티에서도 해결 방안과 대안을 검토하고 있지만 완전한 해결책은 없는것이 현실
- 때문에 새로운 블록체인 기반 기술에서는 다른 합의 알고리즘을 채택해 이런 문제를 해결하려는 모습을 볼 수 있다.

#### 1. 51%(과반수의) 문제

- 특정 채굴자가 전체 네트워크의 과반수 이상을 점유하게 된다면 다른 마이너가 생성한 블록을 승인하지 않는 등 결과를 자유롭게 조작할 수 있다.
- 한 노드(마이너)가 과반수 이상의 네트워크를 점유하게 된다면 PoW가 올바르게 동작하지 않게된다.
- 처음부터 문제로 지적이 되어왔지만 그런 상태가 될 것이라고 생각하지 않았었다.
- 하지만 중국 채굴 참가자가 70~80%를 넘어선 지금 문제가 될 지도 모른다.

#### 2. 파이널리티 불확실성

- PoW는 블록체인이 분기하는 경우 긴 블록체인을 올바른 것으로 판단한다. 
- 짧은 체인을 사용하고 있던 노드에서는 긴 체인이 채택돼 블록의 전환이 발생하면 다양한 문제가 발생할 수 있다.
- 계좌 잔액이 변경되거나 거래 자체가 없었던 일이 되는 경우가 발생할 수 있다.
- 비트코인은 이런 현상을 방지하기 위해 거래가 확정되더라도 6블럭 가량 기다리지 않으면 다음 거래를 할 수 없는 등 제한을 설정하고 있는 지갑도 존재 한다.
- 이처럼 파이널리티(결제완전성 = 송금 등 결제 처리가 확실하게 집행되는것)가 불확실한 것이 금융 시스템에 도입되기 힘든 이유 중 하나이다.

#### 3. 성능한계

- P2P 네트워크에서 단일 정보를 공유하는 구조상 네트워크에 확산되는 시간을 없애는 것은 불가능 하다.
- 여러 노드간 합의를 통해 정보의 신뢰성을 담보하고 있기 때문에 합의에 걸리는 시간도 필요하다
- 성능(응답 시간과 처리량)을 올리는 것은 어려우며 실시간으로 처리해야 하는 업무에는 적합하지 않다.

#### 4. 블록체인의 용량

- 블록체인은 참가자 전원이 트랜젝션 실행 결과를 검토해 신뢰성을 확보한다
- 때문에 모든 블록 정보를 각각의 노드가 보유해야 한다. 비트코인의 블록용량은 80GB
- 향후에도 지속적으로 증가해나갈 것 이기 때문에 하드 디스크의 용량의 압박과 초기 실행 시간의 증가가 우려됨

## PoW 말고 다른 합의 알고리즘

불특성 다수의 사용자가 참가하는 인터넷과 같은 환경에서 PoW는 유효한 알고리즘이다
하지만 신뢰된 참가자들이 컨소시엄을 만들어 운용하는 비즈니스 모델에서는 쓸모없는 기능이다.
컨소시엄형 블록체인에서는 악의가 있는 참가자에 대한 대처보다는 처리 속도와 처리량 및 파이널리티의 확실성이 중요하다. 이 경우의 합의 알고리즘으로는 정해진 참가자가 판단을 내릴 수 없으며 고속으로 동작할 수 있는 것이 있어야 한다.


## 대표적인 합의 알고리즘과 채택한 시스템

| 합의 알고리즘  | 채택 시스템            |
|----------------|------------------------|
| Proof of Work  | Bitcoin Core, Ethereum |
| Proof of Stake | Ethereum mijin         |
| Paxos          | Google Chubby          |
| Raft           | RAMCloud               |
| PBFT           | Hyperledger Fabric     |
| Sieve          | Hyperledger Fabric     |


