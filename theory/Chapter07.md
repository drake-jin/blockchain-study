# 7장 P2P 네트워크

P2P네트워크의 개요를 설명한 뒤 P2P 네트워크를 바탕으로 어떻게 블록체인 기술이 성립되는지에 대해 알아보자.

## 용어 및 팁:

## P2P네트워크의 개요

패스

## P2P 의 종류

- **퓨어 P2P:** 인덱스 서버없이 자신이 원하는 데이터를 검색하는 기능을 노드상호간에 자율적으로 이루어 한다.

- **하이브리드 P2P:** 각 노드가 보유한 데이터의 정보가 인덱스 서버에 기록된다. 노드는 자신이 요구하는 데이터의 소유자를 익덱스 서버에 질의하고 데이터 가지고 있는 Peer를 찾아서 데이터교환을 한다.

## 오버레이 네트워크

- 퓨어 P2P 형 시스템은 중앙 서버 없이 노드 탐색을 실현하기 위해 응용프로그램 수준의 네트워크를 구축해야 한다. 이것을 '오버레이 네트워크' 라고 한다.
- 오버레이 네트워크란 기존 물리 네트워크를 바탕으로 새롭게 만들어지는 가낭 네트워크, 오버레이 네트워크에서 말하는 이웃 노드는 물리적인 이웃이 아니라 논리적인 이웃 노드 이다.
- 오버레이 네트워크는 각 노드와 노드간 통신 경로에서 구성돼 실제 네트워크와는 다른 네트워크 토폴로지를 가진다.
- 오버레이 네트워크는 토폴로지와 노드의 검색 방법에 따라 비구조화 오버레이와 구조화 오버레이로 나뉜다.

## 비구조화 오버레이

- 비구조화 오버레이 : 각 노드가 인접 노드를 선택할 때 제약이 없도록 설꼐한 오버레이 네트워크 이다. 즉, 특정 네트워크 토폴로지가 규정되지 않았다.
- 비구조화 오버레이의 노드 탐색은 메시지를 인접노드에 차례로 전파에 확산시키는 방법을 사용한다.
- 메세지에 요청됙데이터의 메타 정보를 포함시켜 그 메타 정보에 맞는 데이터를 가진 노드를 탐색하는 등 유연한 탐색이 가능하다는 것
- 하지만 이 방식은 목적 노드에 메시지가 전달되는 것을 보장할 수 없다
- 노드 수가 증가하면 네트워크에 메시지가 너무 많아지는 확장성 문제가 발생한다는 단점이 있다.
- 비구조화 오버레이에서 메시지 전파 문제를 해결하기 위해 일부 시스템에서는 '슈퍼 노드'라는 개념을 도입했다. 이것은 일부 노드를 다른 일반 노드보다 상위 노드로 만드는 것
- 슈퍼노드는 다수의 일반노드를 자기 밑에 놓고 메시지의 전파는 슈퍼 노드 끼리 구축된 네트워크에서 이루어진다.
- 슈퍼노드는 네트워크에 참가하는 노드 수에 따라 수가 조절된다.
- 슈퍼 노드의 임명은 노드와 네트워크의 성능을 통해 자율적으로 이루어 진다.
- 비구조화 오버레이의 단점은 목적지 노드에 메시지가 도달하는 것을 보장할 수 없다, 확장성에 문제가 있다

## 구조화 오버레이

- 구조화 오버레이 : 각 노드별로 연결할 상대가 미리 정해져 있다.
- 네트워크 토폴로지도 엄격하게 설계된 오버레이 네트워크 이다.
- 각 노드에는 ID가 할당되고 ID에 따라 연결할 상대가 결정된다.
- 그 결과 링크형 또는 트리형 같은 구조를 가진 오버레이 네트워크가 구축된다.
- 전형적인 구조화 오버레이 위에서는 각 데이터에 대해서도 노드와 동일한 ID가 할당돼 각 데이터는 자신의 ID와 가장 가까운 ID를 가진 노드에 저장된다.
- 메시지 전송도 ID를 사용한 경로 선택ㄷ(라우팅 - Routing)으로 이루어진다.
- 메시지에는 대상 ID를 기재해 대상 ID에 가까운 인접노드가 선택되게 한다
- 이렇게 전송이 반복되면 대상 ID에게 메시지가 도착된다.
- 구조화 오버레이의 장점은 메시지 도착 가능성 및 확장성이 높다
- 구조화 오버레이의 단점은 ID등을 기반으로 메시지를 전송하기 때문에 비구조화 오버레이와 같이 유연한 탐색은 할 수 없다. 대부분 구조화 오버레이 검색 알고리즘은 데이터 ID를 사용한 완전 일치 탐색만 가능하다.


## P2P 네트워크에 따른 블록체인의 동작(개요)

- Bitcoin Core와 같은 이더리움 같은합의 알고리즘에 Proof of Work(계산량 증명)을 채택하고 있는 블록체인 기반을 예로 이야기 한다.
- 컨소시엄형 Hyperledger Fabric은 합의알고리즘으로 Practical Byzantine Fault Tolerant(PBFT)등을 채용하고 있다. 

## P2P 네트워크에 따른 블록체인의 동작

1. 블록체인을 구성하는 P2P 네트워크에서 한 노드(노드 X라고 한다)가 거래 데이터(트렌젝션)를 보낸다. 아직 이 시점에서 거래 자체는 실행(성립)되지 않은 상태이다.
2. 노드 X로 부터 P2P 네트워크로 전달된 트랜젝션은 네트워크에 참가하고 있는 모든 노드로 전파된다. 이처럼 자신이 작성한 거래 데이터를 블록체인 네트워크에 전송하고 모든 참가 노드에 전파시키는 것을 '브로드캐스트'라 한다.
3. 트랜잭션을 받은 모든 노드가 마이닝을 실시해 조건에 맞는 해시값을 발견하면 기존의 블록체인에 새로운 블록을 추가한다.(발행자는 노드 Y라 가정)  이것을 Proof of Work(PoW)
4. 새로운 블록을 추가한 노드 Y는 블록을 P2P 네트워크에 브로드캐스트 한다.
5. 블록을 받은 각 노드는 블록이 올바른 것인지 검증하고, 문제가 없다면 해당 블록을 받아들여 자신이 가지고 있는 블록체인을 업데이트 한다. 그리고 이 시점에서 거래가 성립된다.

## P2P 네트워크에서 다른 노드와의 연계

우선 Bitcoin Core가 P2P네트워크에서 다른 노드와 연결하는 방법을 살펴보자

1. Bitcoin Core는 초기 참가시 DNS(bitseed.xf2.org)를 통해 검색ㅘㄴ다.
2. 클라이언트 소프트웨어에 사전에 하드코딩된 준 영구 노드 목록을 참고한다.
3. 명령줄에서 지정한 IP주소 순서대로 네트워크의 노드 목록을 취득하려고 시도한다.
4. 2번째 이후 부터는 그떄까지 네트워크에서 인식한 노드 목록을 각 클라이언트의 내부 데이터베이스에 보존해놓기 때문에 그 정보를 바탕으로 다른 노드와의 연계를 시도한다.

다음 이더리움의 P2P네트워크에서 다른 노드와 연결하는 방법에 대해 살펴보자

1. 이더리움의 경우 시작점이 되는 노드에서 사전에 하드코딩된 부트스트랩 노드 목록을 참조해 연결을 시도한다
2. 부트스트랩 노드는 기동시 명령줄에서 지정할 수 있다.
3. 그 밖의 다른 노드들은 디스커버리 프로토콜을 사용해 발견할 수 있다.

다음은 Hyperledger Fabric의 P2P네트워크에서 다른 노드와 연결하는 방법에 대해 살펴보자

1. Hyperledfer Fabric은 기동시 지정한 시작점이 되는 노드(CORE_PEER_DISCOVERY_ROOTNODE)에 대한 디스커버리 프로토콜을 발행해서 참가자 목록을 받아온다.
2. 해당 노드가 Validating Peer냐 Non-Validating Peer냐에 따라 달라진다.
3. -1 Validating Peer일 경우 정보를 전파하기 위해 자신을 제외한 모든 Validating Peer와 매시형태의 네트워크를 구축한다.
3. -2 Non-Validating Peer의 경우 연결이 허용된 가장 가까운 Validating Peer와 연결을 수행한다.

## 데이터(블록) 송 수신

Bitcoin Core
 
- Bitcoin Core는 정보 본체를 송신할 때 그 해시값을 inv 메시지로 상대방에게 보내준다
- Bitcoin Core는 정보를 수신할 때에는 getdata메세지를 보내 정보의 본체를 요구하는 특징을 가지고 있다.
- Bitcoin Core의 이런 방식은 P2P네트워크를 흐르는 데이터 양을 줄일 수 있다.

이더리움 

- 이더리움은 블록체인의 데이터 자체가 아니라 그 해시를 모든 노드가 공유하는 공간에 체인으로 저장해 '워크 풀'로 이용한다.
- 이더리움은 '워크 풀'에서 자기 노드에게 부족한 데이터를 찾고, 해시를 이용해 블록을 요청하거나 획득한다.

Hyperledger Fabric

- Hyperledger Fabric은 노드간 통신에 gRPC를 이용하며 이를 통해 양방향 스트림 기반 메시징을 할 수 있다.
- Hpyerledger Fabric은 직렬화된 Protocol Buffers를 사용하고 있다.
- gRPC와 Protocol Buffers는 모두 구글에서 개발한 기술이다 
- Hyperledger Fabric에서 사용한 gRPC와 Protocol Buffers는 Go언어의 레퍼런스를 기반으로 만들어진것 같다.

## P2P 를 사용하는 블록체인의 향후과제

1. 안전성
2. 신뢰성
3. 브로드캐스트의 확실성
4. 전송횟수
5. 네트워크 지연
6. 성능

- **안전성:** 블록체인은 높은 가용성으로 주목받고 있지만, P2P관점에서 본다면 특정 네트워크 토폴로지를 유지하는 구조를 갖추지 않은 블록체인은 비교적 네트워크 끊킴 현상이 일어나기 쉽다. 질의 내용 변조나 이클립스 공격 등에 대한 다양한 대응을 고려해야한다.
- **신뢰성:** 어던 노드가 장시간 P2P네트워크에 참가하고 있다면 그 노드의 신뢰성은 높다고 할 수 있지만, 네트워크에 자주 들락날락 거리는 노드는 신뢰하고 확실한 통신을 수행하는 것이 어렵다. 그리고 신뢰성 자체를 측정하는 방법도 다양하기 때문에 검토가 필요하다.
- **브로드캐스트의 확실성:** 블록체인 네트워크 전체에서 동기화가 가능한지, 도착 보증(수신 확인)은 어떻게 할 것인지에 대한 과제가 남아있다.
- **전송횟수:** 한꺼번에 같은 정보를 공유할 수 없다. 여러번 각 개인에게 전송해야한다.
- **네트워크 지연:** 한번에 같은 정보를 공유하지 않고 순차적으로 모든 노드에게 전송하기 떄문에 지연이 걸리게 된다.
- **성능:** P2P네트워크에 참가하는 노드의 성능과 네트워크의 대역폭은 모두 제각각이기 때문에 성능을 향상시키기 위한 연구가 필요하다.



















